# Setup Environment for UVA Rivanna and using SLURM

This template can be easily adapted to other SLURM clusters.  If you
have done so, please get in contact with Gregor von Laszewski
(laszewski@gmail.com), so we can add the templates. This will enable
us to more easily rerun the benchmarks.

1. Install a modern python to drive the automation.

```bash
module purge
module load anaconda

conda create -y -n py3.10 python=3.10
source activate py3.10
```

2. Establish the minimal toolset to run the cloudmesh sbatch command.

```bash
python3.10 -m venv ~/ENV3
source ~/ENV3/bin/activate
pip install cloudmesh-installer
cloudmesh-installer get sbatch
```

3. Generating experiment configurations

```bash
export EQ_VERSION=latest
git clone https://github.com/laszewsk/mlcommons.git
cd benchmarks/earthquake/${EQ_VERSION}/experiments/rivanna
# cd benchmarks/earthquake/${EQ_VERSION}/experiments/summit
# partition ds6011-sp22-002 

# running under /project
cms sbatch generate rivanna.in.slurm --setup=rivanna-project.yaml --name="project" --noos 
# You can manually inspect the job files in $(pwd)/project/<identifier>
# To verify the output is correct


# partition bii_gpu
#running under /localscratch
cms sbatch generate rivanna.in.slurm --setup=rivanna-localscratch.yaml --name="localscratch" --noos

#running under /dev/shm
cms sbatch generate rivanna.in.slurm --setup=rivanna-shm.yaml --name="shm" --noos

#running dgx
cms sbatch generate rivanna-dgx.in.slurm --setup=rivanna-dgx.yaml --name="dgx" --noos

# Generate the submit scripts
cms sbatch generate submit --name="project.json" > job-project.sh
cms sbatch generate submit --name="localscratch.json" > job-localscratch.sh
cms sbatch generate submit --name="shm.json" > job-shm.sh
cms sbatch generate submit --name="dgx.json" > job-dgx.sh
```

It's strongly advised that you inspect the output of the above to
validate that all generated scripts and files are correct.  Most jobs
take several hours, so correcting errors by inspecting the output will
save time when troubleshooting.

**IMPORTANT** On Rivanna, when using the `/project`or `/scratch`
filesystems, there is a file limit quota that will terminate your job
immediately if you exceed it.  Make sure that you do not run more than
5 jobs concurrently in the `project` configuration.


3. Running the experiments

If all the output from above looks correct, you can execute the jobs
by running the last two scripts that are generated by cms sbatch
generate submit.

```bash
sh job-project.sh # Note comment out all but 5 lines
sh job-localscratch.sh
sh job-shm.sh
sh job-dgx.sh
```

This will request all jobs to be run immediately by slurm, and the
notebook file will be outputted in:

* Project: `$(pwd)/project/<experiment_id>`
* Localscratch: `$(pwd)/localscratch/<experiment_id>`
* SHM: `$(pwd)/shm/<experiment_id>`
* DGX: `$(pwd)/dgx/<experiment_id>`

You can see the progress of each job by inspecting the `*.out` and
`*.err` files located in any of the aforementioned output folders.

A copy of the final notebook is placed in the slurm expeeriments
folder with the suffix `*_output.ipynb`, that can be inspected for
further details.
